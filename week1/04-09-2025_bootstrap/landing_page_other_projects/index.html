<!doctype html>
<html lang="en">
<head>
  <!--
    Landing page to list other people's projects and allow updating (uploading)
    their index.html from a GitHub repository using a single "Update" button.

    Notes for maintainers:
    - This is a static, client-side implementation using Bootstrap 5 and vanilla JS.
    - It attempts to fetch the raw index.html from GitHub (raw.githubusercontent.com).
      Because this runs in the browser, CORS and GitHub branch/path details may block
      some repos. The script tries common branches (main, master) and accepts
      explicit branch/path input if provided in the GitHub URL.
    - When the fetch succeeds the page stores the HTML in memory (and optionally
      in localStorage) and updates the project card preview and the "Download" link.
    - This is intentionally simple and self-contained to be dropped into any static
      host. For production, you would want server-side validation and sanitisation
      before embedding arbitrary HTML in an iframe.
  -->

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Projects Landing â€” Link & Update</title>

  <!-- Bootstrap 5 CSS (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    /* Small custom styles to make the grid look nicer */
    body { padding-top: 4.5rem; }
    .project-card { min-height: 220px; }
    .preview-iframe { width: 100%; height: 300px; border: 1px solid #ddd; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace; }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Projects Landing</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu" aria-controls="navMenu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navMenu">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link active" href="#">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="#addProject">Add Project</a></li>
        </ul>
        <form class="d-flex" role="search" id="quickAddForm">
          <!-- Quick add form to add a project by repo URL -->
          <input id="quickRepoInput" class="form-control me-2" type="search" placeholder="GitHub repo URL (github.com/owner/repo)" aria-label="Repo URL">
          <button id="quickAddBtn" class="btn btn-outline-light" type="submit">Add</button>
        </form>
      </div>
    </div>
  </nav>

  <main class="container">

    <!-- Header / Hero -->
    <header class="py-4 mb-4 border-bottom">
      <div class="row align-items-center">
        <div class="col">
          <h1 class="display-6">Collective Projects</h1>
          <p class="lead">A simple landing page to link other people's projects. Paste a GitHub repo and click <strong>Update</strong> to fetch its <code>index.html</code>.</p>
        </div>
        <div class="col-auto">
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#aboutModal">How it works</button>
        </div>
      </div>
    </header>

    <!-- Projects grid -->
    <section id="projectsGrid" class="row g-3">
      <!-- Project cards will be injected here by JavaScript -->
    </section>

    <!-- Add project form (expanded area) -->
    <section id="addProject" class="my-5">
      <h2>Add a project</h2>
      <p class="text-muted">Provide a title, author, and GitHub repo URL. Then you can click <em>Update</em> on the project to fetch its index.html from GitHub.</p>

      <form id="addProjectForm" class="row g-3">
        <div class="col-md-4">
          <label for="projTitle" class="form-label">Project title</label>
          <input id="projTitle" class="form-control" placeholder="Example: Cool Demo" required>
        </div>
        <div class="col-md-3">
          <label for="projAuthor" class="form-label">Author</label>
          <input id="projAuthor" class="form-control" placeholder="Author name" required>
        </div>
        <div class="col-md-5">
          <label for="projRepo" class="form-label">GitHub repository URL</label>
          <input id="projRepo" class="form-control" placeholder="https://github.com/owner/repo" required>
        </div>

        <div class="col-12">
          <button class="btn btn-success" type="submit">Add project</button>
        </div>
      </form>
    </section>

  </main>

  <!-- About modal explaining behavior and CORS caveats -->
  <div class="modal fade" id="aboutModal" tabindex="-1" aria-labelledby="aboutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="aboutModalLabel">How "Update" works</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>This page attempts to fetch the project's <code>index.html</code> directly from GitHub's raw content service. Example accepted repo URLs:</p>
          <ul>
            <li><code>https://github.com/owner/repo</code> (fetches <em>raw.githubusercontent.com/owner/repo/main/index.html</em> or fallback to <em>master</em>)</li>
            <li><code>https://github.com/owner/repo/tree/branch/path</code> (fetches the specified branch/path)</li>
          </ul>
          <p><strong>Caveats:</strong></p>
          <ul>
            <li>If the repository is private or the raw URL is wrong, the fetch will fail.</li>
            <li>CORS may block embedding or fetching some raw resources. The script does its best by trying common branch names.</li>
            <li>Embedding arbitrary HTML in an iframe may execute scripts from the fetched page. For production usage you should sanitise or render a static preview server-side.</li>
          </ul>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Template for a project card (hidden in DOM) -->
  <template id="projectCardTpl">
    <div class="col-12 col-md-6 col-lg-4">
      <div class="card project-card h-100">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title proj-title">Project title</h5>
          <h6 class="card-subtitle mb-2 text-muted proj-author">by Author</h6>

          <p class="proj-repo mono small text-truncate">Repo: <span class="repo-url">-</span></p>

          <!-- Buttons row -->
          <div class="mt-auto">
            <div class="d-flex gap-2 mb-2">
              <!-- Update button: fetch index.html from GitHub and update preview -->
              <button class="btn btn-sm btn-outline-primary btn-update">Update</button>

              <!-- Download link appears when we have fetched content -->
              <a class="btn btn-sm btn-outline-success btn-download disabled" href="#" download="index.html">Download</a>

              <!-- Open in new tab: blob will be used if available -->
              <a class="btn btn-sm btn-outline-secondary btn-open" target="_blank" rel="noopener">Open</a>

              <!-- Remove project -->
              <button class="btn btn-sm btn-danger ms-auto btn-remove">Remove</button>
            </div>

            <!-- Small help text -->
            <div class="small text-muted mb-2">Fetched: <span class="fetched-at">never</span></div>

            <!-- Preview area: uses iframe to isolate fetched HTML -->
            <div class="preview-area">
              <iframe class="preview-iframe" sandbox="allow-scripts allow-same-origin"></iframe>
            </div>

          </div>
        </div>
      </div>
    </div>
  </template>

  <!-- Bootstrap JS Bundle (includes Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- App JavaScript: heavy commenting included -->
  <script>
    // =========================
    // Utility: parse GitHub repo URL
    // =========================
    // Accepts many GitHub URL forms and returns an object you can use to build
    // raw.githubusercontent.com URLs. If parsing fails, returns null.
    function parseGithubUrl(url) {
      try {
        const u = new URL(url);
        // Only accept github.com hostnames
        if (!/github\.com$/i.test(u.hostname)) return null;

        // Path segments: e.g. /owner/repo, /owner/repo/tree/branch/path
        const parts = u.pathname.split('/').filter(Boolean);
        if (parts.length < 2) return null; // need at least owner/repo

        const owner = parts[0];
        const repo = parts[1];

        // default: no explicit branch or path
        let branch = null;
        let path = '';

        // If URL contains /tree/<branch>/... or /blob/<branch>/path/to/file
        if (parts.length >= 4 && (parts[2] === 'tree' || parts[2] === 'blob')) {
          branch = parts[3];
          if (parts.length > 4) {
            path = parts.slice(4).join('/');
          }
        }

        return { owner, repo, branch, path };
      } catch (e) {
        return null;
      }
    }

    // =========================
    // Utility: construct candidate raw URLs for index.html
    // =========================
    // We'll try multiple candidates to cope with different default branches and
    // with or without a path prefix in the repo URL.
    function buildRawCandidates({ owner, repo, branch, path }) {
      const candidates = [];
      // If explicit branch is provided, try that first
      if (branch) {
        const base = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}`;
        if (path) candidates.push(`${base}/${path.replace(/\/$/, '')}/index.html`);
        candidates.push(`${base}/index.html`);
      }

      // Try common default branches
      const defaults = ['main', 'master'];
      defaults.forEach(b => {
        const base = `https://raw.githubusercontent.com/${owner}/${repo}/${b}`;
        if (path) candidates.push(`${base}/${path.replace(/\/$/, '')}/index.html`);
        candidates.push(`${base}/index.html`);
      });

      // Also try GitHub Pages raw URL variant if repository uses gh-pages branch
      candidates.push(`https://${owner}.github.io/${repo}/`);

      // Deduplicate while preserving order
      return [...new Set(candidates)];
    }

    // =========================
    // Attempt to fetch the raw index.html from the list of candidate URLs
    // Returns a Promise that resolves with {url, text} when one succeeds, or
    // rejects with an array of errors for each candidate.
    // =========================
    async function fetchIndexFromGithub(candidates) {
      const errors = [];
      for (const url of candidates) {
        try {
          // For GitHub Pages root (owner.github.io/repo/) we fetch as page
          const isPages = /github\.io/.test(url) && url.endsWith('/');

          const resp = await fetch(url, { cache: 'no-store' });
          if (!resp.ok) {
            errors.push({ url, status: resp.status });
            continue;
          }

          // Try to read text
          const text = await resp.text();
          return { url, text, isPages };
        } catch (err) {
          errors.push({ url, error: err.message || err });
          // continue to next candidate
        }
      }
      throw errors;
    }

    // =========================
    // Application state: list of projects
    // Each project object: { id, title, author, repoUrl, fetchedAt, blobUrl }
    // =========================
    const state = {
      projects: [],
    };

    // Load persisted projects from localStorage (optional)
    function loadState() {
      try {
        const raw = localStorage.getItem('projectsLanding.v1');
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed.projects)) state.projects = parsed.projects;
      } catch (e) {
        console.warn('Could not load saved state', e);
      }
    }

    function saveState() {
      try {
        localStorage.setItem('projectsLanding.v1', JSON.stringify(state));
      } catch (e) {
        console.warn('Could not save state', e);
      }
    }

    // =========================
    // Render functions
    // =========================
    const projectsGrid = document.getElementById('projectsGrid');
    const tpl = document.getElementById('projectCardTpl');

    function renderProjects() {
      projectsGrid.innerHTML = '';
      state.projects.forEach(p => {
        const node = tpl.content.cloneNode(true);
        const col = node.querySelector(':scope > div');
        const card = node.querySelector('.card');

        // set visible content
        card.querySelector('.proj-title').textContent = p.title;
        card.querySelector('.proj-author').textContent = 'by ' + p.author;
        card.querySelector('.repo-url').textContent = p.repoUrl;
        card.querySelector('.fetched-at').textContent = p.fetchedAt || 'never';

        const btnUpdate = card.querySelector('.btn-update');
        const btnDownload = card.querySelector('.btn-download');
        const btnOpen = card.querySelector('.btn-open');
        const btnRemove = card.querySelector('.btn-remove');
        const iframe = card.querySelector('iframe');

        // If we previously fetched content and have a blob URL, wire up download/open
        if (p.blobUrl) {
          btnDownload.classList.remove('disabled');
          btnDownload.href = p.blobUrl;
          btnOpen.href = p.blobUrl;
          iframe.src = p.blobUrl;
        } else {
          btnDownload.classList.add('disabled');
          btnDownload.removeAttribute('href');
          btnOpen.removeAttribute('href');
          iframe.removeAttribute('src');
        }

        // Update handler: fetch index.html and update project
        btnUpdate.addEventListener('click', async () => {
          // Provide immediate visual feedback
          btnUpdate.disabled = true;
          btnUpdate.textContent = 'Updating...';

          const parsed = parseGithubUrl(p.repoUrl);
          if (!parsed) {
            alert('Could not parse the GitHub URL. Make sure it looks like: https://github.com/owner/repo');
            btnUpdate.disabled = false;
            btnUpdate.textContent = 'Update';
            return;
          }

          const candidates = buildRawCandidates(parsed);

          try {
            const result = await fetchIndexFromGithub(candidates);
            // Create a blob and object URL for safe embedding and download
            const blob = new Blob([result.text], { type: 'text/html' });
            const blobUrl = URL.createObjectURL(blob);

            // Update state
            p.fetchedAt = new Date().toLocaleString();
            p.blobUrl = blobUrl;
            p.rawUrl = result.url; // which raw URL succeeded

            saveState();
            // Re-render to update UI (or just apply changes)
            renderProjects();

            // Restore button state
            btnUpdate.disabled = false;
            btnUpdate.textContent = 'Update';

            // Optionally show a small success toast/modal
            alert('Index.html fetched successfully from:\n' + result.url);
          } catch (errors) {
            console.error('All fetch attempts failed', errors);
            btnUpdate.disabled = false;
            btnUpdate.textContent = 'Update';
            alert('Failed to fetch index.html from the repository. Check the console for details.');
          }
        });

        // Remove handler
        btnRemove.addEventListener('click', () => {
          if (!confirm('Remove this project from the landing page?')) return;
          // Revoke blob URL if present to free memory
          if (p.blobUrl) URL.revokeObjectURL(p.blobUrl);
          state.projects = state.projects.filter(x => x.id !== p.id);
          saveState();
          renderProjects();
        });

        // Append to grid
        projectsGrid.appendChild(col);
      });
    }

    // =========================
    // Add project form handling
    // =========================
    document.getElementById('addProjectForm').addEventListener('submit', (ev) => {
      ev.preventDefault();
      const title = document.getElementById('projTitle').value.trim();
      const author = document.getElementById('projAuthor').value.trim();
      const repoUrl = document.getElementById('projRepo').value.trim();

      if (!title || !author || !repoUrl) return;

      const newProj = {
        id: 'p_' + Math.random().toString(36).slice(2, 9),
        title, author, repoUrl,
        fetchedAt: null,
        blobUrl: null,
        rawUrl: null,
      };

      state.projects.unshift(newProj); // add to start
      saveState();
      renderProjects();

      // Reset form
      ev.target.reset();
    });

    // Quick add from navbar form
    document.getElementById('quickAddForm').addEventListener('submit', (ev) => {
      ev.preventDefault();
      const repo = document.getElementById('quickRepoInput').value.trim();
      if (!repo) return;
      // Basic auto-fill with the repo as title if none
      const titleGuess = repo.split('/').slice(-1)[0] || 'Repo';
      const newProj = {
        id: 'p_' + Math.random().toString(36).slice(2, 9),
        title: titleGuess,
        author: 'Unknown',
        repoUrl: repo,
        fetchedAt: null,
        blobUrl: null,
        rawUrl: null,
      };
      state.projects.unshift(newProj);
      saveState();
      renderProjects();
      document.getElementById('quickRepoInput').value = '';
    });

    // =========================
    // Initialization: load state and seed one example project
    // =========================
    loadState();
    if (state.projects.length === 0) {
      // Seed with an example user project so the user can see how it behaves
      state.projects.push({
        id: 'seed1',
        title: 'Example: HTML5 Boilerplate',
        author: 'Jane Developer',
        repoUrl: 'https://github.com/h5bp/html5-boilerplate',
        fetchedAt: null,
        blobUrl: null,
        rawUrl: null,
      });
    }
    renderProjects();

    // Cleanup: when the page is unloaded, revoke any blob URLs we created
    window.addEventListener('beforeunload', () => {
      state.projects.forEach(p => {
        if (p.blobUrl) URL.revokeObjectURL(p.blobUrl);
      });
    });

  </script>
</body>
</html>

